# –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API Workers

**–î–∞—Ç–∞:** 23 –Ω–æ—è–±—Ä—è 2025  
**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ê–Ω–∞–ª–∏–∑ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è  
**–¶–µ–ª–µ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:** –¥–æ 100 –∫–ª—é—á–µ–π

---

## üîç –ß—Ç–æ —Ç–∞–∫–æ–µ API Workers?

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Workers (–≤–æ—Ä–∫–µ—Ä—ã)** - —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Python, –∫–æ—Ç–æ—Ä—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –≤—Ö–æ–¥—è—â–∏–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ API. –ö–∞–∂–¥—ã–π worker –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥—Ä—É–≥–∏—Ö.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
–ö–ª–∏–µ–Ω—Ç 1 ‚îÄ‚îÄ‚îê
–ö–ª–∏–µ–Ω—Ç 2 ‚îÄ‚îÄ‚î§
–ö–ª–∏–µ–Ω—Ç 3 ‚îÄ‚îÄ‚îº‚îÄ‚îÄ> Nginx/Reverse Proxy ‚îÄ‚îÄ> API Server (Uvicorn)
–ö–ª–∏–µ–Ω—Ç 4 ‚îÄ‚îÄ‚î§                              ‚îÇ
–ö–ª–∏–µ–Ω—Ç 5 ‚îÄ‚îÄ‚îò                              ‚îÇ
                                          ‚ñº
                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ  Worker 1   ‚îÇ ‚Üê –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
                                    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                                    ‚îÇ  Worker 2   ‚îÇ ‚Üê –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
                                    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                                    ‚îÇ  Worker 3   ‚îÇ ‚Üê –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
                                    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                                    ‚îÇ  Worker 4   ‚îÇ ‚Üê –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è workers

1. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º** - –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ª—É—á—à–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
4. **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** - –µ—Å–ª–∏ –æ–¥–∏–Ω worker —É–ø–∞–¥–µ—Ç, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –ß—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ .env —Ñ–∞–π–ª–µ:**
```bash
VPN_WORKERS=4
VPN_WORKER_MAX_REQUESTS=500
```

**2. Systemd —Å–µ—Ä–≤–∏—Å:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ `.env` —Ñ–∞–π–ª–∞
- ‚úÖ Fallback –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (2) –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ workers

**3. –ö–æ–¥ API:**
- ‚úÖ –ß–∏—Ç–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `VPN_WORKERS`
- ‚úÖ Fallback –Ω–∞ 2 –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ –ü–µ—Ä–µ–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ uvicorn

### ‚úÖ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ)

**–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –í `.env` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: `VPN_WORKERS=4` ‚úÖ
- –ó–∞–ø—É—â–µ–Ω–æ workers: **4 workers** ‚úÖ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
- CPU cores: **1 core**
- Master –ø—Ä–æ—Ü–µ—Å—Å: 1 (uvicorn)
- Resource tracker: 1 (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)
- **–ò—Ç–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:** 6 (1 master + 1 tracker + 4 workers)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:**
```
uvicorn (master)
‚îú‚îÄ‚îÄ resource_tracker (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π)
‚îú‚îÄ‚îÄ worker 1 (PID: 3526897)
‚îú‚îÄ‚îÄ worker 2 (PID: 3526898)
‚îú‚îÄ‚îÄ worker 3 (PID: 3526899)
‚îî‚îÄ‚îÄ worker 4 (PID: 3526900)
```

**–í—ã–≤–æ–¥:** ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ! 4 workers –∑–∞–ø—É—â–µ–Ω—ã –∏ –∞–∫—Ç–∏–≤–Ω—ã.

---

## üéØ –ö–∞–∫ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å

### –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã

**1. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```python
# api.py:947
workers = int(os.getenv("VPN_WORKERS", "2"))
```

**2. –ü–µ—Ä–µ–¥–∞—á–∞ –≤ uvicorn:**
```python
# api.py:956
uvicorn_kwargs = {
    "host": host,
    "port": port,
    "workers": workers,  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ worker –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
}
```

**3. Systemd –∑–∞–ø—É—Å–∫:**
```bash
# systemd/vpn-api.service:14
uvicorn api:app --workers ${VPN_WORKERS:-2}
```

**4. Uvicorn —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã:**
- Uvicorn –∑–∞–ø—É—Å–∫–∞–µ—Ç master –ø—Ä–æ—Ü–µ—Å—Å
- Master –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–µ—Ç N worker –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–≥–¥–µ N = VPN_WORKERS)
- –ö–∞–∂–¥—ã–π worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

**–ü—Ä–∏ `VPN_WORKERS=4`:**
```
–ü—Ä–æ—Ü–µ—Å—Å—ã:
‚îú‚îÄ‚îÄ Master –ø—Ä–æ—Ü–µ—Å—Å (uvicorn)
‚îî‚îÄ‚îÄ 4 Worker –ø—Ä–æ—Ü–µ—Å—Å–∞
    ‚îú‚îÄ‚îÄ Worker 1 (PID: 1234)
    ‚îú‚îÄ‚îÄ Worker 2 (PID: 1235)
    ‚îú‚îÄ‚îÄ Worker 3 (PID: 1236)
    ‚îî‚îÄ‚îÄ Worker 4 (PID: 1237)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
ps aux | grep "uvicorn api:app" | grep -v grep
# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å 5 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: 1 master + 4 workers
```

---

## üîß –î–µ—Ç–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è 100 –∫–ª—é—á–µ–π

### –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ workers

**–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞:**
```
workers = (CPU cores √ó 2) + 1
```

**–î–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:**
- CPU cores: **1**
- –ü–æ —Ñ–æ—Ä–º—É–ª–µ: (1 √ó 2) + 1 = **3 workers**
- **–ù–û:** –¥–ª—è 100 –∫–ª—é—á–µ–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º **4 workers**

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è 100 –∫–ª—é—á–µ–π

**–£—á–∏—Ç—ã–≤–∞—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
1. **100 –∫–ª—é—á–µ–π** - –≤—ã—Å–æ–∫–∞—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
2. **1 CPU core** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
3. **API –∑–∞–ø—Ä–æ—Å—ã** - –º–æ–≥—É—Ç –±—ã—Ç—å —á–∞—Å—Ç—ã–º–∏ (–±–æ—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**

```bash
# –ú–∏–Ω–∏–º—É–º –¥–ª—è 100 –∫–ª—é—á–µ–π
VPN_WORKERS=4

# –ï—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –≤—ã—Å–æ–∫–∞—è, –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 6
# (–Ω–æ –Ω–µ –±–æ–ª–µ–µ, —Ç.–∫. 1 CPU core)
VPN_WORKERS=6
```

**–ü–æ—á–µ–º—É 4-6 –¥–ª—è 1 CPU core?**
- Python workers –∏—Å–ø–æ–ª—å–∑—É—é—Ç GIL (Global Interpreter Lock)
- I/O –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Å–µ—Ç—å, –ë–î) –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç GIL
- API –≤ –æ—Å–Ω–æ–≤–Ω–æ–º I/O bound (–∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î, —Å–µ—Ç—å)
- –ü–æ—ç—Ç–æ–º—É –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ workers, —á–µ–º CPU cores

### –ü–∞—Ä–∞–º–µ—Ç—Ä max_requests

**–ß—Ç–æ —ç—Ç–æ:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ worker –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- –ü–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏

**–¢–µ–∫—É—â–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:**
```bash
VPN_WORKER_MAX_REQUESTS=500
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- ‚úÖ 500 - —Ö–æ—Ä–æ—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 1000, –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø–∞–º—è—Ç—å—é
- –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å—Ç–∞–≤–∏—Ç—å 0 (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)

---

## üìà –ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```bash
#!/bin/bash
# check_workers.sh

echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ API Workers ==="
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
echo "üìÑ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ .env:"
if [ -f "/root/vpn-server/.env" ]; then
    VPN_WORKERS=$(grep "^VPN_WORKERS=" /root/vpn-server/.env | cut -d'=' -f2)
    VPN_MAX_REQUESTS=$(grep "^VPN_WORKER_MAX_REQUESTS=" /root/vpn-server/.env | cut -d'=' -f2)
    echo "  VPN_WORKERS: ${VPN_WORKERS:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}"
    echo "  VPN_WORKER_MAX_REQUESTS: ${VPN_MAX_REQUESTS:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}"
else
    echo "  ‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
echo "üîÑ –ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
WORKER_COUNT=$(ps aux | grep "uvicorn api:app" | grep -v grep | wc -l)
echo "  –í—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ uvicorn: $WORKER_COUNT"
echo "  (1 master + N workers = $WORKER_COUNT –ø—Ä–æ—Ü–µ—Å—Å–æ–≤)"
ACTUAL_WORKERS=$((WORKER_COUNT - 1))
echo "  –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ workers: $ACTUAL_WORKERS"

echo ""

# 3. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
echo "üíª –°–∏—Å—Ç–µ–º–∞:"
CPU_CORES=$(nproc)
echo "  CPU cores: $CPU_CORES"
MEMORY_TOTAL=$(free -m | awk '/^Mem:/{print $2}')
echo "  –ü–∞–º—è—Ç—å: ${MEMORY_TOTAL}MB"

echo ""

# 4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
if [ -z "$VPN_WORKERS" ]; then
    echo "  ‚ö†Ô∏è  VPN_WORKERS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2)"
    echo "  ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: VPN_WORKERS=4 –¥–ª—è 100 –∫–ª—é—á–µ–π"
elif [ "$VPN_WORKERS" -lt 4 ]; then
    echo "  ‚ö†Ô∏è  VPN_WORKERS=$VPN_WORKERS (–º–µ–Ω—å—à–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞)"
    echo "  ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: VPN_WORKERS=4 –¥–ª—è 100 –∫–ª—é—á–µ–π"
elif [ "$ACTUAL_WORKERS" -ne "$VPN_WORKERS" ]; then
    echo "  ‚ö†Ô∏è  –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ $VPN_WORKERS, –∑–∞–ø—É—â–µ–Ω–æ $ACTUAL_WORKERS"
    echo "  ‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞: sudo systemctl restart vpn-api"
else
    echo "  ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞: $VPN_WORKERS workers –∑–∞–ø—É—â–µ–Ω–æ"
fi

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
echo ""
echo "üìä –¢–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:"
if command -v systemctl >/dev/null 2>&1; then
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
    echo "  CPU –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ${CPU_USAGE}%"
    
    MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')
    echo "  –ü–∞–º—è—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ${MEMORY_USAGE}%"
fi
```

### –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–ï—Å–ª–∏ workers –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º:**

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env —Ñ–∞–π–ª
cat /root/vpn-server/.env | grep VPN_WORKERS

# 2. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å systemd –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
sudo systemctl daemon-reload
sudo systemctl restart vpn-api

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ workers –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å
ps aux | grep "uvicorn api:app" | grep -v grep | wc -l
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 5 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (1 master + 4 workers)
```

### –®–∞–≥ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–î–æ–±–∞–≤–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤ API:**

```python
@app.get("/api/system/workers/status")
async def get_workers_status(api_key: str = Depends(verify_api_key)):
    """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å API workers"""
    try:
        import subprocess
        import os
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö worker –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        result = subprocess.run(
            ['pgrep', '-f', 'uvicorn api:app'],
            capture_output=True,
            text=True
        )
        all_processes = result.stdout.strip().split('\n') if result.stdout.strip() else []
        running_workers = len([p for p in all_processes if p]) - 1  # -1 –¥–ª—è master –ø—Ä–æ—Ü–µ—Å—Å–∞
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ .env
        env_workers = int(os.getenv("VPN_WORKERS", "2"))
        env_max_requests = int(os.getenv("VPN_WORKER_MAX_REQUESTS", "500"))
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        cpu_cores = os.cpu_count() or 1
        memory = psutil.virtual_memory()
        
        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è —Å —É—á–µ—Ç–æ–º 100 –∫–ª—é—á–µ–π
        if cpu_cores == 1:
            recommended_workers = 4  # –ú–∏–Ω–∏–º—É–º –¥–ª—è 100 –∫–ª—é—á–µ–π –¥–∞–∂–µ –Ω–∞ 1 CPU
        else:
            recommended_workers = min((cpu_cores * 2) + 1, 8)
            if recommended_workers < 4:
                recommended_workers = 4
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        status = "ok"
        if running_workers != env_workers:
            status = "mismatch"
        elif running_workers < 4:
            status = "warning"
        
        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
        recommendation = _get_workers_recommendation(
            env_workers, 
            running_workers, 
            recommended_workers,
            cpu_cores
        )
        
        return {
            "configured_workers": env_workers,
            "running_workers": running_workers,
            "max_requests_per_worker": env_max_requests,
            "cpu_cores": cpu_cores,
            "memory_total_mb": round(memory.total / 1024 / 1024, 2),
            "memory_used_mb": round(memory.used / 1024 / 1024, 2),
            "memory_percent": memory.percent,
            "recommended_workers": recommended_workers,
            "status": status,
            "recommendation": recommendation,
            "timestamp": int(time.time())
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Failed to get workers status: {str(e)}")

def _get_workers_recommendation(
    configured: int, 
    running: int, 
    recommended: int,
    cpu_cores: int
) -> str:
    """–î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ workers"""
    
    if running != configured:
        return f"‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ {configured} workers, –Ω–æ –∑–∞–ø—É—â–µ–Ω–æ {running}. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫: sudo systemctl restart vpn-api"
    
    if configured < 4:
        return f"‚ö†Ô∏è –î–ª—è 100 –∫–ª—é—á–µ–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 4 workers. –¢–µ–∫—É—â–µ–µ: {configured}. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ: {recommended}. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ VPN_WORKERS=4 –≤ .env"
    
    if cpu_cores == 1 and configured > 6:
        return f"‚ö†Ô∏è –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å 1 CPU core –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ 6 workers. –¢–µ–∫—É—â–µ–µ: {configured}. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ: 4-6"
    
    if configured < recommended:
        return f"üí° –î–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è {recommended} workers. –¢–µ–∫—É—â–µ–µ: {configured}"
    
    if configured == recommended:
        return f"‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞: {configured} workers (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ: {recommended})"
    
    return f"‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è workers: {configured} (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ: {recommended})"
```

### –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–°–∫—Ä–∏–ø—Ç –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

```bash
#!/bin/bash
# test_workers_performance.sh

API_KEY="your-api-key"
API_URL="https://server:8000"

echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ API ==="
echo ""

# –¢–µ—Å—Ç 1: –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
echo "üìä –¢–µ—Å—Ç 1: 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ /api/keys"
time (
    for i in {1..10}; do
        curl -s -H "X-API-Key: $API_KEY" "$API_URL/api/keys" > /dev/null &
    done
    wait
)

echo ""
echo "üìä –¢–µ—Å—Ç 2: 50 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"
time (
    for i in {1..50}; do
        curl -s -H "X-API-Key: $API_KEY" "$API_URL/api/keys" > /dev/null
    done
)

echo ""
echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
```

---

## üìã –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (5 –º–∏–Ω—É—Ç)

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
   ```bash
   ps aux | grep "uvicorn api:app" | grep -v grep | wc -l
   ```

2. **–ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –º–µ–Ω—å—à–µ 4 workers:**
   ```bash
   # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å systemd –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
   sudo systemctl daemon-reload
   
   # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
   sudo systemctl restart vpn-api
   
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   ps aux | grep "uvicorn api:app" | grep -v grep | wc -l
   ```

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (30 –º–∏–Ω—É—Ç)

1. **–î–æ–±–∞–≤–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** (`/api/system/workers/status`)
2. **–°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏** (`check_workers.sh`)
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ workers
3. **–ê–ª–µ—Ä—Ç—ã** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (1 CPU core, 100 –∫–ª—é—á–µ–π)

**–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```bash
VPN_WORKERS=4
VPN_WORKER_MAX_REQUESTS=500
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- ‚úÖ –ú–∏–Ω–∏–º—É–º –¥–ª—è 100 –∫–ª—é—á–µ–π
- ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è 1 CPU core
- ‚úÖ –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏

**–ï—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –≤—ã—Å–æ–∫–∞—è:**
```bash
VPN_WORKERS=6  # –ú–∞–∫—Å–∏–º—É–º –¥–ª—è 1 CPU core
```

**–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
- ‚ùå –ú–µ–Ω—å—à–µ 4 workers (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è 100 –∫–ª—é—á–µ–π)
- ‚ùå –ë–æ–ª—å—à–µ 6 workers (–∏–∑–±—ã—Ç–æ—á–Ω–æ –¥–ª—è 1 CPU core)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
- ‚úÖ –ù–µ—Ç –∑–∞–¥–µ—Ä–∂–µ–∫ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- ‚úÖ CPU –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 50-80% (–Ω–µ 100%)
- ‚úÖ –ü–∞–º—è—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–∞ (–Ω–µ—Ç —É—Ç–µ—á–µ–∫)
- ‚úÖ –í—Å–µ workers –∞–∫—Ç–∏–≤–Ω—ã

**–ü—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–±–ª–µ–º:**
- ‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ (>1 —Å–µ–∫—É–Ω–¥–∞)
- ‚ö†Ô∏è CPU –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –Ω–∞ 100%
- ‚ö†Ô∏è Workers –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `sudo journalctl -u vpn-api -f`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã: `htop` –∏–ª–∏ `top`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: `/root/vpn-server/.env`
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: `/api/system/workers/status`

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é


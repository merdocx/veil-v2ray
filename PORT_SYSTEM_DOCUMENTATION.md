# –°–∏—Å—Ç–µ–º–∞ —Ç–æ—á–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —Ç–æ—á–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç 100% —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ–¥—Å—á–µ—Ç–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ VPN –∫–ª—é—á–∞ –ø—É—Ç–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ö–ª–∏–µ–Ω—Ç 1 ‚Üí –ü–æ—Ä—Ç 10001 ‚Üí Xray ‚Üí –ò–Ω—Ç–µ—Ä–Ω–µ—Ç
–ö–ª–∏–µ–Ω—Ç 2 ‚Üí –ü–æ—Ä—Ç 10002 ‚Üí Xray ‚Üí –ò–Ω—Ç–µ—Ä–Ω–µ—Ç
...
–ö–ª–∏–µ–Ω—Ç N ‚Üí –ü–æ—Ä—Ç 1000N ‚Üí Xray ‚Üí –ò–Ω—Ç–µ—Ä–Ω–µ—Ç
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

1. **PortManager** (`port_manager.py`) - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞–º–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
2. **XrayConfigManager** (`xray_config_manager.py`) - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray
3. **PortTrafficMonitor** (`port_traffic_monitor.py`) - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ –ø–æ—Ä—Ç–∞–º
4. **API Extensions** - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ API

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã

```bash
# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /root/vpn-server

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod +x *.py
```

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π

```bash
# –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏
python3 migrate_to_ports.py
```

–ú–∏–≥—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –°–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π
- –ù–∞–∑–Ω–∞—á–∞–µ—Ç –ø–æ—Ä—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞
- –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Xray
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
python3 test_port_system.py
```

## API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞–º–∏

#### GET /api/system/ports
–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ—Ä—Ç–æ–≤

**–û—Ç–≤–µ—Ç:**
```json
{
  "port_assignments": {
    "used_ports": {...},
    "port_assignments": {...}
  },
  "used_ports": 5,
  "available_ports": 15,
  "max_ports": 20,
  "port_range": "10001-10100",
  "timestamp": 1234567890
}
```

#### POST /api/system/ports/reset
–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø–æ—Ä—Ç—ã

#### GET /api/system/ports/status
–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ—Ä—Ç–æ–≤

### –¢–æ—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞—Ñ–∏–∫–∞

#### GET /api/traffic/ports/exact
–ü–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ –ø–æ—Ä—Ç–∞–º

**–û—Ç–≤–µ—Ç:**
```json
{
  "ports_traffic": {
    "total_ports": 5,
    "ports_traffic": {
      "uuid-1": {
        "port": 10001,
        "key_name": "User 1",
        "traffic": {
          "port": 10001,
          "connections": 2,
          "total_bytes": 1048576,
          "total_formatted": "1.0 MB",
          "timestamp": 1234567890
        }
      }
    },
    "total_traffic": 5242880,
    "total_connections": 10
  },
  "system_summary": {
    "total_system_traffic": 10485760,
    "active_ports": 5,
    "interface_summary": {...}
  },
  "source": "port_monitor",
  "timestamp": 1234567890
}
```

#### GET /api/keys/{key_id}/traffic/port/exact
–ü–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∫–ª—é—á–∞ –ø–æ –ø–æ—Ä—Ç—É

#### POST /api/keys/{key_id}/traffic/port/reset
–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∫–ª—é—á–∞ –ø–æ –ø–æ—Ä—Ç—É

#### GET /api/system/traffic/summary
–ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Xray

#### GET /api/system/xray/config-status
–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray

#### POST /api/system/xray/sync-config
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Xray —Å –∫–ª—é—á–∞–º–∏

#### GET /api/system/xray/validate-sync
–í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray

## –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### –ö–ª—é—á —Å –ø–æ—Ä—Ç–æ–º
```json
{
  "id": "uuid",
  "name": "string",
  "uuid": "string", 
  "port": 10001,
  "created_at": "timestamp",
  "is_active": true
}
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ—Ä—Ç–∞
```json
{
  "port": 10001,
  "uuid": "user-uuid",
  "connections": 2,
  "total_bytes": 1048576,
  "rx_bytes": 524288,
  "tx_bytes": 524288,
  "total_formatted": "1.0 MB",
  "rx_formatted": "512.0 KB",
  "tx_formatted": "512.0 KB",
  "interface_traffic": {...},
  "total_interface_traffic": 10485760,
  "timestamp": 1234567890
}
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Xray

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ inbound –¥–ª—è –∫–ª—é—á–∞
```json
{
  "port": 10001,
  "protocol": "vless",
  "settings": {
    "clients": [
      {
        "id": "uuid-1",
        "flow": "",
        "email": "uuid-1"
      }
    ],
    "decryption": "none"
  },
  "streamSettings": {
    "network": "tcp",
    "security": "reality",
    "realitySettings": {
      "show": false,
      "dest": "www.microsoft.com:443",
      "xver": 0,
      "serverNames": ["www.microsoft.com"],
      "privateKey": "generated-key",
      "shortIds": ["generated-id"],
      "maxTimeDiff": 600
    }
  },
  "tag": "inbound-uuid-1"
}
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
curl -H "X-API-Key: YOUR_API_KEY" http://localhost:8000/api/system/ports

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
curl -H "X-API-Key: YOUR_API_KEY" http://localhost:8000/api/traffic/ports/exact

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray
curl -H "X-API-Key: YOUR_API_KEY" http://localhost:8000/api/system/xray/config-status
```

### –õ–æ–≥–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞

```bash
# –õ–æ–≥–∏ Xray
tail -f /root/vpn-server/logs/access.log
tail -f /root/vpn-server/logs/error.log

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤
ss -tuln | grep 1000

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cat /root/vpn-server/config/config.json
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –ú–∞–∫—Å–∏–º—É–º 100 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π
- –î–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤: 10001-10100
- –í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö: –Ω–µ –±–æ–ª–µ–µ 2 —Å–µ–∫—É–Ω–¥

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –ö–∞–∂–¥—ã–π –∫–ª—é—á –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π Reality
- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤
**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤
curl -H "X-API-Key: YOUR_API_KEY" http://localhost:8000/api/system/ports

# –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–ª—é—á–∏
curl -X DELETE -H "X-API-Key: YOUR_API_KEY" http://localhost:8000/api/keys/{key_id}
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray
**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
curl -X POST -H "X-API-Key: YOUR_API_KEY" http://localhost:8000/api/system/xray/sync-config

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
curl -H "X-API-Key: YOUR_API_KEY" http://localhost:8000/api/system/xray/validate-sync
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Ç–æ—á–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫
**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
curl -X POST -H "X-API-Key: YOUR_API_KEY" http://localhost:8000/api/keys/{key_id}/traffic/port/reset

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
ss -tuln | grep {port}
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ú–µ—Ç—Ä–∏–∫–∏
- –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞: ~3 —Å–µ–∫—É–Ω–¥—ã
- –í—Ä–µ–º—è —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞: ~3 —Å–µ–∫—É–Ω–¥—ã
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API: <100ms
- –¢–æ—á–Ω–æ—Å—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: 100%

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (30 —Å–µ–∫—É–Ω–¥)
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ú–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ—Ä—Ç–æ–≤
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ—Ä—Ç–æ–≤
- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### API –∫–ª—é—á
–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ç—Ä–µ–±—É—é—Ç –≤–∞–ª–∏–¥–Ω—ã–π API –∫–ª—é—á –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-API-Key`.

## –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –º–∏–≥—Ä–∞—Ü–∏—è

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
```bash
# –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
cp -r /root/vpn-server /root/vpn-server-backup-$(date +%Y%m%d)

# –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã
# ... –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ ...

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
python3 migrate_to_ports.py

# –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É
python3 test_port_system.py
```

### –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
cp -r /root/vpn-server-backup-YYYYMMDD/* /root/vpn-server/

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
systemctl restart xray
```

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –õ–æ–≥–∏
- API –ª–æ–≥–∏: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤—ã–≤–æ–¥ FastAPI
- Xray –ª–æ–≥–∏: `/root/vpn-server/logs/`
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏: `journalctl -u xray`

### –ö–æ–Ω—Ç–∞–∫—Ç—ã
–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

---

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ 